// ============================================================================
// HEKAX Phone - Prisma Schema
// Version: 2.0.0
// ============================================================================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// ENUMS
// ============================================================================

enum OrgStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  CANCELLED
  PENDING_SETUP
}

enum Plan {
  TRIAL
  STARTER
  BUSINESS_PRO
  SCALE
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  AGENT
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  INVITED
  SUSPENDED
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  QUEUED
  RINGING
  IN_PROGRESS
  COMPLETED
  BUSY
  NO_ANSWER
  FAILED
  CANCELLED
  VOICEMAIL
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
  UNQUALIFIED
}

enum LeadUrgency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum LeadTemp {
  HOT
  WARM
  COLD
}

// ============================================================================
// ORGANIZATION
// ============================================================================

model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique

  status    OrgStatus @default(ACTIVE)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Onboarding
  onboardingCompleted Boolean @default(false)
  industry            String  @default("general")

 // Telephony - Auto-provisioned per organization
  twilioNumber          String?  @unique
  twilioAccountSid      String?  // Legacy: direct account (deprecated)
  twilioAuthToken       String?  // Legacy: direct token (deprecated)
  twilioSubAccountSid   String?  // Subaccount SID (auto-created)
  twilioSubAccountToken String?  // Subaccount Auth Token (auto-created)
  twimlAppSid           String?  // TwiML App SID (auto-created)
  twilioApiKeySid       String?  // API Key SID for access tokens
  twilioApiKeySecret    String?  // API Key Secret (encrypted)
  twilioProvisioned     Boolean  @default(false)  // Full provisioning complete?
  twilioProvisionedAt   DateTime?  // When provisioning completed
  forwardingNumber      String?
  pendingPhoneNumber    String?  // Selected during trial, purchased on subscription

  // AI Receptionist
  aiEnabled       Boolean @default(true)
  voiceId         String?
  voiceProvider   String  @default("elevenlabs")
  greeting        String?
  personality     String  @default("professional")
  language        String  @default("en-US")
  maxCallDuration Int     @default(600)
  maxTurns        Int     @default(20)
  aiModel         String  @default("gpt-4o")
  aiTemperature   Float   @default(0.7)
  systemPrompt    String? @db.Text

  // Business Hours
  timezone           String  @default("America/New_York")
  businessHours      Json?
  afterHoursMode     String  @default("ai")
  afterHoursGreeting String?

  // Branding
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String  @default("#3b82f6")
  secondaryColor String  @default("#8b5cf6")
  customDomain   String? @unique
  emailFromName  String?
  emailFromDomain String?

  // Billing
  plan                 Plan     @default(TRIAL)
  billingCycle         String   @default("monthly")
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?
  trialEndsAt          DateTime?
  billingPeriodStart   DateTime?
  billingPeriodEnd     DateTime?

  // Overage Settings
  overageEnabled     Boolean @default(false)
  overageCapCents    Int     @default(15000) // $150 default cap
  overageUsedCents   Int     @default(0)     // Current overage charges this period

  // Usage Limits
  monthlyCallMinutes Int @default(1000)
  monthlyAIMinutes   Int @default(300)
  maxUsers           Int @default(2)
  maxPhoneNumbers    Int @default(1)

  // Current Usage
  usedCallMinutes  Int       @default(0)
  usedAIMinutes    Int       @default(0)
  usageResetAt     DateTime?
  aiGraceStartedAt DateTime? // When AI grace period started (48hr)

  // Add-on Pool (from purchased add-ons)
  addonCallMinutes     Int @default(0)
  addonAIMinutes       Int @default(0)
  usedAddonCallMinutes Int @default(0)
  usedAddonAIMinutes   Int @default(0)

  // Integrations
  slackWebhookUrl    String?
  teamsWebhookUrl    String?
  notifyOnNewLead    Boolean @default(true)
  notifyOnMissedCall Boolean @default(true)

  // SMS Settings (JSON: { followUpEnabled, followUpTemplate, missedCallSms, appointmentReminders })
  smsSettings        String? @db.Text

  // BYO Keys (Enterprise Feature)
  byoKeysEnabled       Boolean @default(false)
  byoOpenaiKey         String? // Encrypted
  byoElevenlabsKey     String? // Encrypted
  byoDeepgramKey       String? // Encrypted
  byoTwilioAccountSid  String?
  byoTwilioAuthToken   String? // Encrypted
  byoTwilioNumber      String?
  byoKeysValidatedAt   DateTime?

  // Data Retention Settings
  retentionCallDays       Int      @default(90)   // Days to keep call logs
  retentionTranscriptDays Int      @default(90)   // Days to keep transcripts
  retentionRecordingDays  Int      @default(30)   // Days to keep recordings
  retentionLeadDays       Int      @default(365)  // Days to keep closed leads
  retentionAuditDays      Int      @default(365)  // Days to keep audit logs
  retentionEnabled        Boolean  @default(true)
  lastCleanupAt           DateTime?
  dataExportRequests      DataExportRequest[]

  // After Hours Forwarding
  afterHoursForwardNumber String?

  // Relations
  users           User[]
  memberships     UserOrganization[]
  callLogs        CallLog[]
  callRoutes      CallRoute[]
  leads           Lead[]
  transcripts     Transcript[]
  phoneNumbers    PhoneNumber[]
  usageLogs       UsageLog[]
  auditLogs       AuditLog[]
  invoices        Invoice[]
  usageAlerts     UsageAlert[]
  apiKeys         ApiKey[]
  addonPurchases  AddOnPurchase[]
  calendarIntegrations CalendarIntegration[]
  calendarBookings     CalendarBooking[]
  crmIntegrations      CrmIntegration[]
  channels             Channel[]

  @@index([slug])
  @@index([status])
}

// ============================================================================
// USER
// ============================================================================

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String
  name         String
  phone        String?
  avatar       String?
  status       UserStatus @default(ACTIVE)

  twilioIdentity String? @unique

  // Email Verification
  emailVerified           Boolean   @default(false)
  emailVerificationToken  String?   @unique
  emailVerificationCode   String?
  emailVerificationExpires DateTime?

  timezone           String  @default("America/New_York")
  language           String  @default("en")
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)

  lastLoginAt          DateTime?
  lastLoginIp          String?
  mfaEnabled           Boolean   @default(false)
  mfaSecret            String?
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?

  // Current active organization (for session)
  currentOrgId String?

  // Multi-org memberships
  memberships UserOrganization[]

  // Legacy: Direct org relation (kept for backwards compat, will migrate)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  assignedLeads Lead[]    @relation("AssignedAgent")
  callsHandled  CallLog[] @relation("HandledBy")
  calendarConnections CalendarIntegration[] @relation("CalendarConnectedBy")
  crmConnections      CrmIntegration[]      @relation("CRMConnectedBy")
  aiFeedback          AIFeedback[]
  assignedConversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([email])
  @@index([currentOrgId])
}

// ============================================================================
// USER-ORGANIZATION MEMBERSHIP (Multi-org support)
// ============================================================================

model UserOrganization {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  role       UserRole @default(AGENT)
  department String?
  status     String   @default("ACTIVE") // ACTIVE, INACTIVE, INVITED, SUSPENDED
  isPrimary  Boolean  @default(false) // User's primary/default org

  invitedBy   String?
  invitedAt   DateTime @default(now())
  acceptedAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// ============================================================================
// CALLS
// ============================================================================

model CallLog {
  id      String        @id @default(cuid())
  callSid String        @unique

  direction  CallDirection
  fromNumber String
  toNumber   String
  status     CallStatus
  duration   Int           @default(0)
  waitTime   Int?

  recordingUrl      String?
  recordingSid      String?
  recordingDuration Int?

  handledByAI        Boolean @default(false)
  aiConfidence       Float?
  transferredToHuman Boolean @default(false)
  transferReason     String?

  // SMS Follow-up
  followUpSmsSent   Boolean   @default(false)
  followUpSmsSentAt DateTime?

  // Answering Machine Detection
  answeredBy  String? // human, machine_start, machine_end_beep, etc.
  amdDuration Int?

  sentiment      String?
  sentimentScore Float?
  topics         String[]

  cost         Float?
  twilioPrice  Float?
  aiTokensUsed Int?

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  phoneNumberId String?
  phoneNumber   PhoneNumber? @relation(fields: [phoneNumberId], references: [id])

  handledById String?
  handledBy   User?  @relation("HandledBy", fields: [handledById], references: [id])

  transcript Transcript?
  lead       Lead?
  aiFeedback AIFeedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([callSid])
  @@index([status])
  @@index([createdAt])
}

model PhoneNumber {
  id           String  @id @default(cuid())
  number       String  @unique
  friendlyName String?
  twilioSid    String? @unique
  capabilities Json?

  routeToAI    Boolean @default(true)
  routeToUser  String?
  routeToQueue String?

  greeting   String?
  voiceId    String?
  callFlowId String?

  status String @default("active")

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  callLogs CallLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([number])
}

// ============================================================================
// TRANSCRIPTS
// ============================================================================

model Transcript {
  id      String @id @default(cuid())
  callSid String @unique

  fullText String @db.Text
  messages Json

  summary        String? @db.Text
  sentiment      String?
  sentimentScore Float?
  keywords       String[]
  topics         String[]
  actionItems    Json?

  primaryIntent    String?
  intentConfidence Float?
  entities         Json?

  call CallLog @relation(fields: [callSid], references: [callSid])

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([callSid])
}

// ============================================================================
// LEADS
// ============================================================================

model Lead {
  id      String @id @default(cuid())
  callSid String @unique

  name     String
  phone    String
  email    String?
  company  String?
  jobTitle String?
  website  String?

  address    String?
  city       String?
  state      String?
  country    String?
  postalCode String?

  reason                String
  serviceInterest       String?
  preferredCallbackTime String?
  appointmentDate       String?
  appointmentTime       String?
  urgency               LeadUrgency @default(MEDIUM)
  referralSource        String?
  notes                 String?     @db.Text

  score       Int      @default(0)
  temperature LeadTemp @default(WARM)
  isVIP       Boolean  @default(false)

  status     LeadStatus @default(NEW)
  stage      String     @default("new")
  lostReason String?

  estimatedValue Float?
  actualValue    Float?
  currency       String @default("USD")

  assignedToId String?
  assignedTo   User?     @relation("AssignedAgent", fields: [assignedToId], references: [id])
  assignedAt   DateTime?

  source       String @default("phone")
  campaign     String?
  medium       String?
  customFields Json?

  call CallLog @relation(fields: [callSid], references: [callSid])

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  convertedAt DateTime?
  closedAt    DateTime?

  @@index([organizationId])
  @@index([status])
  @@index([phone])
  @@index([createdAt])
}

// ============================================================================
// USAGE TRACKING
// ============================================================================

model UsageLog {
  id String @id @default(cuid())

  type     String // call_minutes, ai_minutes, sms, storage
  quantity Float
  unit     String // minutes, messages, bytes
  unitCost Float?
  totalCost Float?

  periodStart DateTime
  periodEnd   DateTime

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// AUDIT LOGS
// ============================================================================

model AuditLog {
  id String @id @default(cuid())

  actorType  String  // user, system, api
  actorId    String?
  actorEmail String?

  action     String
  entityType String
  entityId   String?

  oldValues String? @db.Text
  newValues String? @db.Text
  metadata  String? @db.Text

  ipAddress String?
  userAgent String? @db.Text

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
}

// ============================================================================
// INVOICES
// ============================================================================

model Invoice {
  id String @id @default(cuid())

  stripeInvoiceId String @unique
  amount          Int // In cents
  currency        String @default("usd")
  status          String // draft, open, paid, void, uncollectible

  periodStart DateTime
  periodEnd   DateTime
  paidAt      DateTime?

  pdfUrl    String?
  hostedUrl String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([status])
}

// ============================================================================
// USAGE ALERTS
// ============================================================================

model UsageAlert {
  id String @id @default(cuid())

  type     String // usage_warning_80, usage_warning_90, etc.
  title    String
  message  String
  severity String @default("info") // info, warning, error

  data String? @db.Text // JSON data

  dismissed   Boolean   @default(false)
  dismissedAt DateTime?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([type])
  @@index([dismissed])
}

// ============================================================================
// API KEYS (Platform API access for Enterprise)
// ============================================================================

model ApiKey {
  id String @id @default(cuid())

  name        String
  keyHash     String   @unique // Hashed key (only show once on creation)
  keyPrefix   String   // First 8 chars for identification (hk_live_...)
  
  permissions String[] // read, write, calls, leads, etc.
  
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  revokedAt   DateTime?
  
  createdById String?
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([keyPrefix])
}

// ============================================================================
// DATA EXPORT REQUEST (GDPR/CCPA Compliance)
// ============================================================================

model DataExportRequest {
  id String @id @default(cuid())

  type      String   // full_export, calls_only, leads_only, transcripts_only
  status    String   @default("pending") // pending, processing, completed, failed, expired
  format    String   @default("json") // json, csv, zip
  
  fileUrl   String?  // Download URL when completed
  fileSize  Int?     // Size in bytes
  expiresAt DateTime? // When download link expires
  
  requestedBy   String
  requestedAt   DateTime @default(now())
  completedAt   DateTime?
  errorMessage  String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
}

// ============================================================================
// CLEANUP LOG (Audit trail for data deletion)
// ============================================================================

model CleanupLog {
  id String @id @default(cuid())

  type           String   // scheduled, manual, gdpr_request
  dataType       String   // calls, transcripts, recordings, leads, audit_logs
  recordsDeleted Int      @default(0)
  bytesFreed     BigInt   @default(0)
  
  cutoffDate     DateTime // Data older than this was deleted
  
  status         String   @default("completed") // completed, partial, failed
  errorMessage   String?
  
  triggeredBy    String?  // user_id or "system"
  
  organizationId String?  // null for system-wide cleanup
  
  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// ADD-ON PURCHASES (One-time minute packs)
// ============================================================================

enum AddOnType {
  CALL_MINUTES
  AI_MINUTES
  BUNDLE
}

enum AddOnStatus {
  ACTIVE      // Has remaining minutes
  EXHAUSTED   // All minutes used
  EXPIRED     // Expired (if we add expiration)
  REFUNDED    // Refunded by admin
}

model AddOnPurchase {
  id String @id @default(cuid())

  // What they bought
  type        AddOnType
  productId   String      // e.g., "call_boost_1000", "ai_boost_500", "growth_bundle"
  productName String
  
  // Minutes included
  callMinutes Int @default(0)
  aiMinutes   Int @default(0)
  
  // Minutes used from this pack
  usedCallMinutes Int @default(0)
  usedAiMinutes   Int @default(0)
  
  // Payment
  priceCents        Int
  stripePaymentId   String?   // Stripe PaymentIntent ID
  stripeInvoiceId   String?   // Stripe Invoice ID (if any)
  
  // Status
  status AddOnStatus @default(ACTIVE)
  
  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  purchasedAt DateTime @default(now())
  exhaustedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([purchasedAt])
}

// ============================================================================
// CALENDAR INTEGRATIONS
// ============================================================================

enum CalendarProviderType {
  GOOGLE
  OUTLOOK
  CALENDLY
}

enum CalendarBookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

model CalendarIntegration {
  id String @id @default(cuid())

  provider    CalendarProviderType
  enabled     Boolean              @default(true)

  // OAuth tokens (encrypted in production)
  accessToken    String  @db.Text
  refreshToken   String? @db.Text
  tokenExpiresAt DateTime?

  // Calendar-specific settings
  calendarId      String? // Primary calendar ID
  calendarName    String?
  webhookId       String? // For Calendly webhooks
  defaultDuration Int     @default(30) // Default meeting duration in minutes

  // Business hours (JSON)
  businessHours Json? // { start: 9, end: 17, days: [1,2,3,4,5], timezone: "America/New_York" }

  // Provider-specific data
  userUri         String? // Calendly user URI
  organizationUri String? // Calendly organization URI
  eventTypeUri    String? // Calendly event type URI

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Who connected it
  connectedById String?
  connectedBy   User?   @relation("CalendarConnectedBy", fields: [connectedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings CalendarBooking[]

  @@unique([organizationId, provider])
  @@index([organizationId])
  @@index([provider])
}

model CalendarBooking {
  id String @id @default(cuid())

  // Event details
  eventId    String? // External calendar event ID
  eventLink  String? // Link to calendar event
  meetLink   String? // Video meeting link (Google Meet, Teams, Zoom)

  // Caller info
  callerName  String
  callerPhone String
  callerEmail String?
  purpose     String?

  // Scheduling
  scheduledAt DateTime
  duration    Int      @default(30) // Duration in minutes
  timezone    String   @default("America/New_York")

  // Status
  status         CalendarBookingStatus @default(PENDING)
  cancelledAt    DateTime?
  cancelReason   String?
  completedAt    DateTime?
  noShowMarkedAt DateTime?

  // Source
  callSid    String? // Call that initiated the booking
  bookedByAI Boolean @default(true)

  // Automation
  reminderSent Boolean @default(false)

  // Relations
  calendarIntegrationId String?
  calendarIntegration   CalendarIntegration? @relation(fields: [calendarIntegrationId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([scheduledAt])
  @@index([status])
  @@index([callerPhone])
}

// ============================================================================
// CRM INTEGRATIONS
// ============================================================================

enum CRMProviderType {
  HUBSPOT
  SALESFORCE
  ZOHO
  PIPEDRIVE
  WEBHOOK
}

enum CRMSyncStatus {
  SUCCESS
  FAILED
  PENDING
}

model CrmIntegration {
  id String @id @default(cuid())

  provider    CRMProviderType
  enabled     Boolean         @default(true)

  // OAuth tokens (for HubSpot, Salesforce, Zoho, Pipedrive)
  accessToken    String?  @db.Text
  refreshToken   String?  @db.Text
  tokenExpiresAt DateTime?
  instanceUrl    String?  // For Salesforce, Pipedrive

  // API Key (for webhook secret or API-based integrations)
  apiKey String? @db.Text

  // Webhook URL (for generic webhook provider)
  webhookUrl String?

  // Sync settings
  syncLeads        Boolean @default(true)
  syncCalls        Boolean @default(true)
  syncTranscripts  Boolean @default(false)
  syncAppointments Boolean @default(true)

  // Mapping settings (JSON)
  fieldMappings Json? // Custom field mappings
  settings      Json? // Provider-specific settings

  // Status
  lastSyncAt   DateTime?
  lastSyncStatus CRMSyncStatus?
  lastError    String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Who connected it
  connectedById String?
  connectedBy   User?   @relation("CRMConnectedBy", fields: [connectedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  syncLogs CrmSyncLog[]

  @@unique([organizationId, provider])
  @@index([organizationId])
  @@index([provider])
}

model CrmSyncLog {
  id String @id @default(cuid())

  syncType   String  // lead, call, transcript, appointment
  entityId   String  // HEKAX entity ID
  externalId String? // CRM entity ID

  status CRMSyncStatus
  error  String?       @db.Text

  requestData  String? @db.Text
  responseData String? @db.Text

  crmIntegrationId String
  crmIntegration   CrmIntegration @relation(fields: [crmIntegrationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([crmIntegrationId])
  @@index([syncType])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// VOICEMAIL
// ============================================================================

model Voicemail {
  id      String @id @default(cuid())
  callSid String @unique

  fromNumber String
  toNumber   String

  // Recording
  recordingUrl      String?
  recordingSid      String?
  duration          Int     @default(0)

  // Transcription
  transcription       String? @db.Text
  transcriptionStatus String  @default("pending") // pending, completed, failed

  // Status
  status  String    @default("new") // new, read, archived, deleted
  readAt  DateTime?
  readBy  String?

  // Organization
  organizationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// CALL ROUTING
// ============================================================================

model CallRoute {
  id   String @id @default(cuid())
  name String

  // Priority (lower = higher priority)
  priority Int @default(0)

  // Action type: FORWARD, VOICEMAIL, DEPARTMENT, AI, QUEUE
  action CallRouteAction

  // Forward settings
  forwardNumber String?

  // Department settings
  department String?

  // Voicemail/greeting settings
  customGreeting String? @db.Text

  // AI settings
  aiPersonality String?

  // Queue settings
  queueId     String?
  maxWaitTime Int? // seconds

  // Time-based conditions
  scheduleStart String?    // HH:MM format
  scheduleEnd   String?    // HH:MM format
  daysOfWeek    Int[]      // 0=Sunday, 6=Saturday

  // Caller conditions
  callerPattern String? // Regex pattern for matching caller numbers

  // Conditional flags
  vipOnly           Boolean @default(false)
  businessHoursOnly Boolean @default(false)

  enabled Boolean @default(true)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([enabled])
  @@index([priority])
}

enum CallRouteAction {
  FORWARD
  VOICEMAIL
  DEPARTMENT
  AI
  QUEUE
}

// ============================================================================
// AI FEEDBACK & LEARNING
// ============================================================================

enum FeedbackType {
  CORRECTION
  RATING
  SUGGESTION
}

enum FeedbackCategory {
  ACCURACY
  TONE
  COMPLETENESS
  RELEVANCE
  TIMING
  OTHER
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  APPLIED
  REJECTED
}

enum LearningStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

model AIFeedback {
  id String @id @default(cuid())

  // What is being reviewed
  callId       String?
  transcriptId String?
  messageIndex Int? // Which message in transcript

  // Feedback details
  feedbackType FeedbackType
  rating       Int? // 1-5 for ratings
  category     FeedbackCategory?

  // Content
  originalResponse  String? @db.Text
  correctedResponse String? @db.Text
  notes             String? @db.Text

  // Review status
  status      FeedbackStatus @default(PENDING)
  reviewNotes String?        @db.Text
  reviewedAt  DateTime?

  // Organization and user
  organizationId String
  userId         String?

  // Relations
  call      CallLog? @relation(fields: [callId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  learningQueue AILearningQueue[]

  @@index([organizationId])
  @@index([callId])
  @@index([status])
  @@index([feedbackType])
  @@index([createdAt])
}

model AILearningQueue {
  id String @id @default(cuid())

  // Reference to feedback
  feedbackId String
  feedback   AIFeedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  // Priority (higher = more important)
  priority Int @default(1)

  // Processing status
  status      LearningStatus @default(PENDING)
  processedAt DateTime?
  result      String?        @db.Text

  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([priority])
}

// ============================================================================
// AI TRAINING DATA
// ============================================================================

model AIFAQ {
  id String @id @default(cuid())

  question String  @db.Text
  answer   String  @db.Text
  category String  @default("general")
  priority Int     @default(0)
  keywords String[]

  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([category])
}

model AIScript {
  id String @id @default(cuid())

  name        String
  description String?  @db.Text
  scenario    String   @db.Text // When to use this script
  script      String   @db.Text // The actual script/response

  isActive Boolean @default(true)

  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([isActive])
}

model AICustomResponse {
  id String @id @default(cuid())

  triggerPhrase String @db.Text  // Phrase that triggers this response
  response      String @db.Text  // The custom response
  matchType     String @default("contains") // exact, contains, regex

  isActive Boolean @default(true)

  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([isActive])
}

model AIKnowledgeBase {
  id String @id @default(cuid())

  title     String
  content   String  @db.Text
  category  String  @default("general")
  source    String? // Where this info came from
  sourceUrl String?

  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([category])
}

// ============================================================================
// MULTI-CHANNEL (WhatsApp, Webchat, etc.)
// ============================================================================

enum ChannelType {
  WHATSAPP
  WEBCHAT
  SMS
  MESSENGER
  TELEGRAM
}

enum ConversationStatus {
  ACTIVE
  CLOSED
  TRANSFERRED
  PENDING
}

model Channel {
  id String @id @default(cuid())

  type    ChannelType
  name    String
  enabled Boolean     @default(true)

  // Channel-specific configuration (JSON)
  config Json @default("{}")

  // AI settings
  greeting      String? @db.Text
  aiEnabled     Boolean @default(true)
  aiPersonality String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, type])
  @@index([organizationId])
  @@index([type])
  @@index([enabled])
}

model Conversation {
  id String @id @default(cuid())

  // External identifiers
  externalId String? // Phone number, session ID, etc.

  // Participant info
  participantName  String?
  participantPhone String?
  participantEmail String?

  // Status
  status      ConversationStatus @default(ACTIVE)
  resolution  String?
  closedAt    DateTime?
  transferredAt DateTime?

  // Assignment
  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  // Metadata
  metadata     Json?
  greetingSent Boolean @default(false)

  // Relations
  channelId String
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  organizationId String

  messages ChannelMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId])
  @@index([organizationId])
  @@index([status])
  @@index([externalId])
  @@index([createdAt])
}

model ChannelMessage {
  id String @id @default(cuid())

  // Direction
  direction String // INBOUND, OUTBOUND

  // Content
  content     String  @db.Text
  contentType String  @default("text") // text, image, file, audio, video

  // External tracking
  externalId String? // Message ID from provider
  status     String  @default("SENT") // PENDING, SENT, DELIVERED, READ, FAILED

  // Response time tracking (ms)
  responseTimeMs Int?

  // Metadata
  metadata Json?

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([direction])
  @@index([createdAt])
}

// ============================================================================
// AUTOMATION ENGINE
// ============================================================================

model AutomationRule {
  id String @id @default(cuid())

  name        String
  description String?
  enabled     Boolean @default(true)
  priority    Int     @default(0)

  // Trigger
  triggerEvent String // Event type that triggers this rule

  // Conditions (JSON array of condition objects)
  conditions Json? // [{ field, operator, value }]

  // Actions (JSON array of action objects)
  actions Json // [{ type, ...params }]

  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs AutomationLog[]

  @@index([organizationId])
  @@index([triggerEvent])
  @@index([enabled])
}

model AutomationLog {
  id String @id @default(cuid())

  ruleId   String?
  ruleName String?

  triggerEvent     String
  eventData        String? @db.Text
  actionsExecuted  Json?
  status           String  // SUCCESS, FAILED
  result           String? @db.Text
  error            String? @db.Text

  organizationId String

  rule AutomationRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([ruleId])
  @@index([status])
  @@index([createdAt])
}

model Task {
  id String @id @default(cuid())

  title       String
  description String?  @db.Text
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED

  dueAt       DateTime?
  completedAt DateTime?

  assignedToId  String?
  relatedLeadId String?

  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([assignedToId])
  @@index([status])
  @@index([dueAt])
}

model Notification {
  id String @id @default(cuid())

  type    String  @default("INFO") // INFO, WARNING, ERROR, SUCCESS
  title   String
  message String  @db.Text

  read   Boolean   @default(false)
  readAt DateTime?

  targetUserId String?
  data         Json?

  organizationId String

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([targetUserId])
  @@index([read])
  @@index([createdAt])
}

model Sequence {
  id String @id @default(cuid())

  name        String
  description String?
  enabled     Boolean @default(true)

  // Steps (JSON array of step objects)
  steps Json // [{ type, delayMinutes, message/subject/body }]

  organizationId String

  enrollments SequenceEnrollment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([enabled])
}

model SequenceEnrollment {
  id String @id @default(cuid())

  currentStep Int      @default(0)
  status      String   @default("ACTIVE") // ACTIVE, PAUSED, COMPLETED, CANCELLED

  nextStepAt  DateTime?
  lastStepAt  DateTime?
  completedAt DateTime?

  sequenceId String
  sequence   Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  leadId String?

  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([sequenceId])
  @@index([leadId])
  @@index([status])
  @@index([nextStepAt])
}
